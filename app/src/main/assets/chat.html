<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Bằng Lái Xe</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4285F4;
            --primary-light: #E8F0FE;
            --primary-dark: #3367D6;
            --bg: #f8f9fa;
            --user-bg: #4285F4;
            --user-text: white;
            --bot-bg: #ffffff;
            --bot-text: #202124;
            --text-dark: #3c4043;
            --text-light: #5f6368;
            --border: #dadce0;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-hover: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            line-height: 1.5;
        }

        .header {
            text-align: center;
            padding: 16px 10px;
            background-color: white;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10;
        }

        .header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .header p {
            margin: 4px 0 0;
            font-size: 14px;
            color: var(--text-light);
            font-weight: 400;
        }

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: var(--bg);
        }

        .message {
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
            font-size: 15px;
            line-height: 1.4;
        }

        .user {
            background: var(--user-bg);
            color: var(--user-text);
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: var(--shadow);
        }

        .bot {
            background: var(--bot-bg);
            color: var(--bot-text);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow);
        }

        #input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
            position: relative;
        }

        #userInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            background: white;
            transition: all 0.2s;
        }

        #userInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        button {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background-color: #dadce0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .typing {
            font-style: italic;
            color: var(--text-light);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border-top: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .quick-buttons.hidden {
            display: none;
        }

        .quick-btn {
            background: white;
            color: var(--primary);
            border: 1px solid var(--border);
            padding: 8px 14px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .quick-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        /* Scrollbar tùy chỉnh */
        #chat::-webkit-scrollbar {
            width: 6px;
        }

        #chat::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 3px;
        }

        #chat::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        /* Hiệu ứng cho tin nhắn mới */
        .message:last-child {
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Trạng thái loading */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--text-light);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .message {
                max-width: 90%;
                font-size: 14px;
            }

            .header h3 {
                font-size: 16px;
            }

            .header p {
                font-size: 13px;
            }

            .quick-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <h3>Chatbot Bằng Lái Xe</h3>
    <p>Hỏi đáp về lý thuyết, biển báo, mẹo thi, sa hình...</p>
</div>

<div id="chat">
    <div class="message bot">
        Chào bạn! Mình là trợ lý chuyên về bằng lái xe máy.<br><br>
        Bạn muốn hỏi về:<br>
        • Thi lý thuyết<br>
        • Biển báo giao thông<br>
        • Mẹo làm bài thi<br>
        • Sa hình, tình huống nguy hiểm<br>
        • Câu hỏi sai nhiều nhất?<br><br>
        <strong>Cứ hỏi thoải mái nhé!</strong>
    </div>
</div>

<div class="quick-buttons" id="quickButtons">
<!--    <div class="quick-btn" onclick="quickSend('Các loại bằng lái xe máy')">Các loại bằng</div>-->
    <div class="quick-btn" onclick="quickSend('Câu hỏi lý thuyết')">Lý thuyết</div>
    <div class="quick-btn" onclick="quickSend('Biển báo cấm là hình gì?')">Biển báo</div>
    <div class="quick-btn" onclick="quickSend('Mẹo làm bài thi sát hạch')">Mẹo thi</div>
    <div class="quick-btn" onclick="quickSend('Tình huống nguy hiểm sa hình')">Sa hình</div>
</div>

<div id="input-area">
    <input type="text" id="userInput" placeholder="Nhập câu hỏi về bằng lái xe..." autocomplete="off">
    <button id="sendBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white"/>
        </svg>
    </button>
</div>

<script>
    // API KEY MỚI CỦA BẠN (đã test OK lúc 01:15 ngày 19/11/2025)
    const API_KEY = 'AIzaSyA_ItgUGz6GR_IezcX7OAwsIwctJFDyj8A';
    const MODEL = 'gemini-2.5-flash';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

    // Tự động thêm prompt hệ thống để chatbot hiểu mình là chuyên gia bằng lái xe
    const SYSTEM_PROMPT = `Bạn là trợ lý AI chuyên về bằng lái xe máy tại Việt Nam.
    Trả lời ngắn gọn, dễ hiểu, bằng tiếng Việt, có ví dụ nếu cần.
    Hãy trả lời thân thiện, nhiệt tình như một thầy dạy lái xe giỏi.`;

    function hideQuickButtons() {
        const quickButtons = document.getElementById('quickButtons');
        quickButtons.classList.add('hidden');
    }

    function addMessage(text, sender, isError = false) {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        div.className = `message ${sender} ${isError ? 'error' : ''}`;
        div.innerHTML = text.replace(/\n/g, '<br>');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function showTypingIndicator() {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        div.className = 'message bot typing';
        div.id = 'typing-indicator';
        div.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function quickSend(text) {
        hideQuickButtons();
        document.getElementById('userInput').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const message = input.value.trim();
        if (!message) return;

        hideQuickButtons();
        addMessage(message, 'user');
        input.value = '';
        document.getElementById('sendBtn').disabled = true;

        showTypingIndicator();

        try {
            // Tạo nội dung request đúng định dạng Gemini API
            const requestBody = {
                contents: [{
                    parts: [{
                        text: SYSTEM_PROMPT + "\n\nCâu hỏi của người dùng: " + message
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024
                }
            };

            console.log("Gửi request:", requestBody); // Debug log

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error:", errorData);
                throw new Error(`Lỗi ${response.status}: ${errorData.error?.message || 'Không rõ nguyên nhân'}`);
            }

            const data = await response.json();
            console.log("API Response:", data); // Debug log

            // Kiểm tra cấu trúc phản hồi để tránh lỗi
            if (!data.candidates ||
                !data.candidates[0] ||
                !data.candidates[0].content ||
                !data.candidates[0].content.parts ||
                !data.candidates[0].content.parts[0]) {
                console.error("Cấu trúc phản hồi không đúng:", data);
                throw new Error("Phản hồi từ API không đúng định dạng");
            }

            const reply = data.candidates[0].content.parts[0].text;

            removeTypingIndicator();
            addMessage(reply, 'bot');
        } catch (error) {
            removeTypingIndicator();
            console.error("Error details:", error);

            let errorMessage = "Đã xảy ra lỗi khi kết nối với server. ";

            if (error.message.includes("Failed to fetch")) {
                errorMessage += "Vui lòng kiểm tra kết nối internet và thử lại.";
            } else if (error.message.includes("quota")) {
                errorMessage += "API key đã hết hạn hoặc vượt quá hạn mức sử dụng.";
            } else {
                errorMessage += `Chi tiết: ${error.message}`;
            }

            addMessage(errorMessage, 'bot', true);
        } finally {
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }
    }

    // Gửi khi nhấn Enter hoặc nút
    document.getElementById('userInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('sendBtn').addEventListener('click', sendMessage);

    // Focus vào ô nhập ngay khi mở
    window.onload = () => document.getElementById('userInput').focus();
</script>
</body>
</html>